<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>E-Ticaret Login & Logout</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        .btn-danger { background-color: #dc3545; }
        .container { max-width: 800px; margin: 0 auto; }
        #result { margin-top: 20px; padding: 15px; border: 1px solid #ddd; background: #f9f9f9; min-height: 50px; white-space: pre-wrap; }
        .status-box { background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ›ï¸ GÃ¼venli E-Ticaret Paneli</h1>

    <div class="status-box">
        <p><strong>Test Senaryosu:</strong></p>
        <ol>
            <li>GiriÅŸ yapÄ±n.</li>
            <li>Veri getirmeyi deneyin.</li>
            <li><strong>Refresh Testi:</strong> Keycloak'ta token sÃ¼resini 1 dk yaptÄ±ysanÄ±z, 1 dk bekleyin ve tekrar veri getirin. Hata almazsanÄ±z Gateway arkada token'Ä± yenilemiÅŸ demektir.</li>
            <li>Ã‡Ä±kÄ±ÅŸ yapÄ±n ve tekrar girmeyi deneyin (Åifre sormalÄ±).</li>
        </ol>
    </div>

    <div id="auth-section">
        <button class="btn" onclick="login()">ğŸ”‘ Keycloak ile GiriÅŸ Yap</button>
        <button class="btn btn-danger" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap (Global Logout)</button>
    </div>

    <hr>
    <h3>Mikroservis Ä°ÅŸlemleri</h3>
    <button class="btn" onclick="getData('/api/products/all')">ğŸ“¦ ÃœrÃ¼nleri Getir (Public)</button>
    <button class="btn" onclick="getData('/api/products/admin-only')">ğŸ”’ Admin ÃœrÃ¼nleri (Superuser)</button>

    <h3>SonuÃ§:</h3>
    <div id="result">HenÃ¼z iÅŸlem yapÄ±lmadÄ±...</div>
</div>

<script>
    // --- AYARLAR ---
    const GATEWAY_URL = "http://localhost:8080";

    // 1. LOGIN
    function login() {
        window.location.href = GATEWAY_URL + "/oauth2/authorization/keycloak";
    }

    // 2. LOGOUT (KESÄ°N Ã‡Ã–ZÃœM - FORM YÃ–NTEMÄ°)
    function logout() {
        const csrfToken = getCsrfToken();

        if (!csrfToken) {
            alert("Hata: CSRF Token bulunamadÄ±! SayfayÄ± yenileyip tekrar deneyin.");
            return;
        }

        // GÃ¶rÃ¼nmez bir form oluÅŸturuyoruz
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = 'http://localhost:8080/logout'; // Gateway adresi

        // CSRF Token'Ä± formun iÃ§ine gizli input olarak ekliyoruz
        // Spring Security hem Header'a hem de '_csrf' parametresine bakar.
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = '_csrf';
        hiddenField.value = csrfToken;

        form.appendChild(hiddenField);
        document.body.appendChild(form);

        // Formu gÃ¶nderiyoruz. Bu iÅŸlem sayfayÄ± yeniler ve yÃ¶nlendirmeleri takip eder.
        form.submit();
    }

    // 3. CSRF TOKEN OKUYUCU (GÃœNCELLENMÄ°Å VERSÄ°YON)
    function getCsrfToken() {
        // Regex ile XSRF-TOKEN deÄŸerini gÃ¼venle Ã§eker
        const match = document.cookie.match(new RegExp('(^| )XSRF-TOKEN=([^;]+)'));
        if (match) {
            console.log("Token Bulundu:", match[2]); // Konsoldan kontrol et
            return match[2];
        }
        console.error("HATA: CSRF Token Cookie'de bulunamadÄ±! Backend filtreyi ekledin mi?");
        return null;
    }

    // 4. VERÄ° Ã‡EKME
    async function getData(endpoint) {
        const resultDiv = document.getElementById('result');
        resultDiv.innerText = "Ä°stek atÄ±lÄ±yor...";
        resultDiv.style.backgroundColor = "#fff3cd"; // SarÄ± (YÃ¼kleniyor)

        const csrfToken = getCsrfToken();

        try {
            const response = await fetch(GATEWAY_URL + endpoint, {
                method: 'GET',
                headers: {
                    'X-XSRF-TOKEN': csrfToken // Header'a ekliyoruz
                }
            });

            if (response.status === 401) {
                resultDiv.innerText = "âš ï¸ Oturum Yok! LÃ¼tfen giriÅŸ yapÄ±n.";
                resultDiv.style.backgroundColor = "#f8d7da"; // KÄ±rmÄ±zÄ±
            } else if (response.status === 403) {
                resultDiv.innerText = "â›” Yetkisiz EriÅŸim! Bu veriyi gÃ¶rmeye rolÃ¼nÃ¼z yetmiyor.";
                resultDiv.style.backgroundColor = "#f8d7da";
            } else {
                const text = await response.text();
                resultDiv.innerText = "âœ… BAÅARILI:\n" + text;
                resultDiv.style.backgroundColor = "#d4edda"; // YeÅŸil
            }
        } catch (error) {
            console.error(error);
            resultDiv.innerText = "âŒ BaÄŸlantÄ± HatasÄ±! Gateway kapalÄ± olabilir.";
            resultDiv.style.backgroundColor = "#f8d7da";
        }
    }
</script>
</body>
</html>